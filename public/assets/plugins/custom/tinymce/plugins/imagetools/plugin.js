!function(t){"use strict";var n,e,r,o=function(t){var n=t;return{get:function(){return n},set:function(t){n=t}}},i=tinymce.util.Tools.resolve("tinymce.PluginManager"),u=tinymce.util.Tools.resolve("tinymce.util.Tools"),a=function(){},c=function(t){return function(){return t}},f=c(!1),s=c(!0),l=function(){return d},d=(n=function(t){return t.isNone()},{fold:function(t,n){return t()},is:f,isSome:f,isNone:s,getOr:r=function(t){return t},getOrThunk:e=function(t){return t()},getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},getOrNull:c(null),getOrUndefined:c(void 0),or:r,orThunk:e,map:l,each:a,bind:l,exists:f,forall:s,filter:l,equals:n,equals_:n,toArray:function(){return[]},toString:c("none()")}),m=function(t){var n=c(t),e=function(){return o},r=function(n){return n(t)},o={fold:function(n,e){return e(t)},is:function(n){return t===n},isSome:s,isNone:f,getOr:n,getOrThunk:n,getOrDie:n,getOrNull:n,getOrUndefined:n,or:e,orThunk:e,map:function(n){return m(n(t))},each:function(n){n(t)},bind:r,exists:r,forall:r,filter:function(n){return n(t)?o:d},toArray:function(){return[t]},toString:function(){return"some("+t+")"},equals:function(n){return n.is(t)},equals_:function(n,e){return n.fold(f,function(n){return e(t,n)})}};return o},h={some:m,none:l,from:function(t){return null==t?d:m(t)}};function g(n,e){return y(t.document.createElement("canvas"),n,e)}function v(t){var n=g(t.width,t.height);return p(n).drawImage(t,0,0),n}function p(t){return t.getContext("2d")}function y(t,n,e){return t.width=n,t.height=e,t}var w=window.Promise?window.Promise:function(){var n=function(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],s(t,r(u,this),r(a,this))},e=n.immediateFn||"function"==typeof window.setImmediate&&window.setImmediate||function(n){t.setTimeout(n,1)};function r(t,n){return function(){return t.apply(n,arguments)}}var o=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};function i(t){var n=this;null!==this._state?e(function(){var e=n._state?t.onFulfilled:t.onRejected;if(null!==e){var r;try{r=e(n._value)}catch(n){return void t.reject(n)}t.resolve(r)}else(n._state?t.resolve:t.reject)(n._value)}):this._deferreds.push(t)}function u(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if("function"==typeof n)return void s(r(n,t),r(u,this),r(a,this))}this._state=!0,this._value=t,c.call(this)}catch(t){a.call(this,t)}}function a(t){this._state=!1,this._value=t,c.call(this)}function c(){for(var t=0,n=this._deferreds;t<n.length;t++){var e=n[t];i.call(this,e)}this._deferreds=[]}function f(t,n,e,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof n?n:null,this.resolve=e,this.reject=r}function s(t,n,e){var r=!1;try{t(function(t){r||(r=!0,n(t))},function(t){r||(r=!0,e(t))})}catch(t){if(r)return;r=!0,e(t)}}return n.prototype.catch=function(t){return this.then(null,t)},n.prototype.then=function(t,e){var r=this;return new n(function(n,o){i.call(r,new f(t,e,n,o))})},n.all=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=Array.prototype.slice.call(1===t.length&&o(t[0])?t[0]:t);return new n(function(t,n){if(0===r.length)return t([]);var e=r.length;function o(i,u){try{if(u&&("object"==typeof u||"function"==typeof u)){var a=u.then;if("function"==typeof a)return void a.call(u,function(t){o(i,t)},n)}r[i]=u,0==--e&&t(r)}catch(t){n(t)}}for(var i=0;i<r.length;i++)o(i,r[i])})},n.resolve=function(t){return t&&"object"==typeof t&&t.constructor===n?t:new n(function(n){n(t)})},n.reject=function(t){return new n(function(n,e){e(t)})},n.race=function(t){return new n(function(n,e){for(var r=0,o=t;r<o.length;r++)o[r].then(n,e)})},n}();function b(n){var e,r=n.src;return 0===r.indexOf("data:")?T(r):(e=r,new w(function(n,r){var o=new t.XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.onload=function(){200===this.status&&n(this.response)},o.onerror=function(){var t,n=this;r(0===this.status?((t=new Error("No access to download image")).code=18,t.name="SecurityError",t):new Error("Error "+n.status+" downloading image"))},o.send()}))}function I(n){return new w(function(e,r){var o=t.URL.createObjectURL(n),i=new t.Image,u=function(){i.removeEventListener("load",a),i.removeEventListener("error",c)};function a(){u(),e(i)}function c(){u(),r("Unable to load data of type "+n.type+": "+o)}i.addEventListener("load",a),i.addEventListener("error",c),i.src=o,i.complete&&a()})}function T(n){return new w(function(e,r){(function(n){var e=n.split(","),r=/data:([^;]+)/.exec(e[0]);if(!r)return h.none();for(var o=r[1],i=e[1],u=t.atob(i),a=u.length,c=Math.ceil(a/1024),f=new Array(c),s=0;s<c;++s){for(var l=1024*s,d=Math.min(l+1024,a),m=new Array(d-l),g=l,v=0;g<d;++v,++g)m[v]=u[g].charCodeAt(0);f[s]=new Uint8Array(m)}return h.some(new t.Blob(f,{type:o}))})(n).fold(function(){r("uri is not base64: "+n)},e)})}function _(n,e,r){return e=e||"image/png",t.HTMLCanvasElement.prototype.toBlob?new w(function(t,o){n.toBlob(function(n){n?t(n):o()},e,r)}):T(n.toDataURL(e,r))}function R(n){return I(n).then(function(n){!function(n){t.URL.revokeObjectURL(n.src)}(n);var e=g(function(t){return t.naturalWidth||t.width}(n),function(t){return t.naturalHeight||t.height}(n));return p(e).drawImage(n,0,0),e})}function U(t,n,e){var r=n.type;function o(n,e){return t.then(function(t){return function(t,n,e){return n=n||"image/png",t.toDataURL(n,e)}(t,n,e)})}return{getType:c(r),toBlob:function(){return w.resolve(n)},toDataURL:c(e),toBase64:function(){return e.split(",")[1]},toAdjustedBlob:function(n,e){return t.then(function(t){return _(t,n,e)})},toAdjustedDataURL:o,toAdjustedBase64:function(t,n){return o(t,n).then(function(t){return t.split(",")[1]})},toCanvas:function(){return t.then(v)}}}function A(n){return function(n){return new w(function(e){var r=new t.FileReader;r.onloadend=function(){e(r.result)},r.readAsDataURL(n)})}(n).then(function(t){return U(R(n),n,t)})}function E(t,n){return _(t,n).then(function(n){return U(w.resolve(t),n,t.toDataURL())})}function x(t,n){return t.toCanvas().then(function(e){return function(t,n,e){var r=g(t.width,t.height),o=p(r),i=0,u=0;90!==(e=e<0?360+e:e)&&270!==e||y(r,r.height,r.width);90!==e&&180!==e||(i=r.width);270!==e&&180!==e||(u=r.height);return o.translate(i,u),o.rotate(e*Math.PI/180),o.drawImage(t,0,0),E(r,n)}(e,t.getType(),n)})}function L(t,n){return t.toCanvas().then(function(e){return function(t,n,e){var r=g(t.width,t.height),o=p(r);"v"===e?(o.scale(1,-1),o.drawImage(t,0,-r.height)):(o.scale(-1,1),o.drawImage(t,-r.width,0));return E(r,n)}(e,t.getType(),n)})}var j,C=(j="function",function(t){return typeof t===j}),k=function(t,n){return function(t,n,e){for(var r=0,o=t.length;r<o;r++){var i=t[r];if(n(i,r))return h.some(i);if(e(i,r))break}return h.none()}(t,n,f)},O=function(t){return A(t)},P=function(t){if(null==t)throw new Error("Node cannot be null or undefined");return{dom:c(t)}},S={fromHtml:function(n,e){var r=(e||t.document).createElement("div");if(r.innerHTML=n,!r.hasChildNodes()||r.childNodes.length>1)throw t.console.error("HTML does not have a single root node",n),new Error("HTML must have a single root node");return P(r.childNodes[0])},fromTag:function(n,e){var r=(e||t.document).createElement(n);return P(r)},fromText:function(n,e){var r=(e||t.document).createTextNode(n);return P(r)},fromDom:P,fromPoint:function(t,n,e){var r=t.dom();return h.from(r.elementFromPoint(n,e)).map(P)}},N=(void 0!==t.window?t.window:Function("return this;")(),C(t.Element.prototype.attachShadow)&&C(t.Node.prototype.getRootNode),function(t,n){return function(t,n){return k(t.dom().childNodes,function(t){return n(S.fromDom(t))}).map(S.fromDom)}(t,function(t){return function(t,n){var e=t.dom();if(1!==e.nodeType)return!1;var r=e;if(void 0!==r.matches)return r.matches(n);if(void 0!==r.msMatchesSelector)return r.msMatchesSelector(n);if(void 0!==r.webkitMatchesSelector)return r.webkitMatchesSelector(n);if(void 0!==r.mozMatchesSelector)return r.mozMatchesSelector(n);throw new Error("Browser lacks native selectors")}(t,n)})}),M=tinymce.util.Tools.resolve("tinymce.util.Delay"),B=tinymce.util.Tools.resolve("tinymce.util.Promise"),D=tinymce.util.Tools.resolve("tinymce.util.URI"),F=function(t){return t.getParam("imagetools_toolbar","rotateleft rotateright flipv fliph editimage imageoptions")},H=function(t){return t.getParam("imagetools_proxy")};function q(t){var n,e;function r(t){return/^[0-9\.]+px$/.test(t)}return n=t.style.width,e=t.style.height,n||e?r(n)&&r(e)?{w:parseInt(n,10),h:parseInt(e,10)}:null:(n=t.width,e=t.height,n&&e?{w:parseInt(n,10),h:parseInt(e,10)}:null)}function z(t){return{w:t.naturalWidth,h:t.naturalHeight}}var $=function(t){return null!=t},G=function(n,e,r){return new B(function(o){var i=new t.XMLHttpRequest;i.onreadystatechange=function(){4===i.readyState&&o({status:i.status,blob:this.response})},i.open("GET",n,!0),i.withCredentials=r,u.each(e,function(t,n){i.setRequestHeader(n,t)}),i.responseType="blob",i.send()})},J=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],K=[{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],V=function(t){var n=function(t){return"ImageProxy HTTP error: "+k(J,function(n){return t===n.code}).fold(c("Unknown ImageProxy error"),function(t){return t.message})}(t);return B.reject(n)},W=function(t){var n,e,r=function(t){var n;try{n=JSON.parse(t)}catch(t){}return n}(t),o=(n=["error","type"].reduce(function(t,n){return $(t)?t[n]:void 0},r),$(n)?n:null);return"ImageProxy Service error: "+(o?(e=o,k(K,function(t){return t.type===e}).fold(c("Unknown service error"),function(t){return t.message})):"Invalid JSON in service error message")},X=function(n,e){return function(n){return new B(function(e){var r=new t.FileReader;r.onload=function(t){var n=t.target;e(n.result)},r.readAsText(n)})}(e).then(function(t){var n=W(t);return B.reject(n)})},Q=function(t,n){var e={"Content-Type":"application/json;charset=UTF-8","tiny-api-key":n};return G(function(t,n){var e=-1===t.indexOf("?")?"?":"&";return/[?&]apiKey=/.test(t)||!n?t:t+e+"apiKey="+encodeURIComponent(n)}(t,n),e,!1).then(function(t){return t.status<200||t.status>=300?(n=t.status,e=t.blob,400===(r=n)||403===r||500===r?X(0,e):V(n)):B.resolve(t.blob);var n,e,r})};var Y=function(t,n,e){return n?Q(t,n):function(t,n){return G(t,{},n).then(function(t){return t.status<200||t.status>=300?V(t.status):B.resolve(t.blob)})}(t,e)},Z=0,tt=function(t){return N(S.fromDom(t),"img")},nt=function(t,n){return t.dom.is(n,"figure")},et=function(t,n){var e=function(n){return function(n){return t.dom.is(n,"img:not([data-mce-object],[data-mce-placeholder])")}(n)&&(it(t,n)||ut(t,n)||H(t))};return nt(t,n)?tt(n).map(function(t){return e(t.dom())?h.some(t.dom()):h.none()}):e(n)?h.some(n):h.none()},rt=function(t,n){t.notificationManager.open({text:n,type:"error"})},ot=function(t){var n=t.selection.getNode();return nt(t,n)?tt(n):h.some(S.fromDom(n))},it=function(t,n){var e=n.src;return 0===e.indexOf("data:")||0===e.indexOf("blob:")||new D(e).host===t.documentBaseURI.host},ut=function(t,n){return-1!==u.inArray(function(t){return t.getParam("imagetools_cors_hosts",[],"string[]")}(t),new D(n.src).host)},at=function(t,n){var e,r=n.src;return ut(t,n)?Y(n.src,null,function(t,n){return-1!==u.inArray(function(t){return t.getParam("imagetools_credentials_hosts",[],"string[]")}(t),new D(n.src).host)}(t,n)):it(t,n)?b(n):(r=H(t),r+=(-1===r.indexOf("?")?"?":"&")+"url="+encodeURIComponent(n.src),e=function(t){return t.getParam("api_key",t.getParam("imagetools_api_key","","string"),"string")}(t),Y(r,e,!1))},ct=function(t,n){return function(t){return h.from(t.getParam("imagetools_fetch_image",null,"function"))}(t).fold(function(){return at(t,n)},function(t){return t(n)})},ft=function(t,n){var e=t.editorUpload.blobCache.getByUri(n.src);return e?B.resolve(e.blob()):ct(t,n)},st=function(t,n){var e=M.setEditorTimeout(t,function(){t.editorUpload.uploadImagesAuto()},function(t){return t.getParam("images_upload_timeout",3e4,"number")}(t));n.set(e)},lt=function(t){M.clearTimeout(t.get())},dt=function(t,n,e,r,o,i){return n.toBlob().then(function(u){var a,c,f,s=t.editorUpload.blobCache;return a=o.src,function(t){return t.getParam("images_reuse_filename",!1,"boolean")}(t)&&((f=s.getByUri(a))?(a=f.uri(),c=f.name()):c=function(t,n){var e=n.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i);return e?t.dom.encode(e[1]):null}(t,a)),f=s.create({id:"imagetools"+Z++,blob:u,base64:n.toBase64(),uri:a,name:c}),s.add(f),t.undoManager.transact(function(){t.$(o).on("load",function n(){t.$(o).off("load",n),t.nodeChanged(),e?t.editorUpload.uploadImagesAuto():(lt(r),st(t,r))}),i&&t.$(o).attr({width:i.w,height:i.h}),t.$(o).attr({src:f.blobUri()}).removeAttr("data-mce-src")}),f})},mt=function(t,n,e,r){return function(){return ot(t).fold(function(){rt(t,"Could not find selected image")},function(o){return t._scanForImages().then(function(){return ft(t,o.dom())}).then(O).then(e).then(function(e){return dt(t,e,!1,n,o.dom(),r)},function(n){rt(t,n)})})}},ht=function(t,n,e){return function(){var r=ot(t).fold(function(){return null},function(t){var n=q(t.dom());return n?{w:n.h,h:n.w}:null});return mt(t,n,function(t){return function(t,n){return x(t,n)}(t,e)},r)()}},gt=function(t,n,e){return function(){return mt(t,n,function(t){return function(t,n){return L(t,n)}(t,e)})()}},vt=function(n,e,r,o,i){return function(t){return I(t)}(i).then(function(n){var e=z(n);return o.w===e.w&&o.h===e.h||q(r)&&function(t,n){var e,r;n&&(e=t.style.width,r=t.style.height,(e||r)&&(t.style.width=n.w+"px",t.style.height=n.h+"px",t.removeAttribute("data-mce-style")),e=t.width,r=t.height,(e||r)&&(t.setAttribute("width",n.w),t.setAttribute("height",n.h)))}(r,e),t.URL.revokeObjectURL(n.src),i}).then(O).then(function(t){return dt(n,t,!0,e,r)},function(){})},pt=function(n,e){return function(){var r=ot(n),o=r.map(function(t){return z(t.dom())});ot(n).each(function(i){et(n,i.dom()).each(function(u){ft(n,i.dom()).then(function(i){var u=function(n){return{blob:n,url:t.URL.createObjectURL(n)}}(i);n.windowManager.open({title:"Edit Image",size:"large",body:{type:"panel",items:[{type:"imagetools",name:"imagetools",label:"Edit Image",currentState:u}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0,disabled:!0}],onSubmit:function(t){var i=t.getData().imagetools.blob;r.each(function(t){o.each(function(r){vt(n,e,t.dom(),r,i)})}),t.close()},onCancel:function(){},onAction:function(t,n){switch(n.name){case"save-state":n.value?t.enable("save"):t.disable("save");break;case"disable":t.disable("save"),t.disable("cancel");break;case"enable":t.enable("cancel")}}})})})})}},yt=function(t,n){u.each({mceImageRotateLeft:ht(t,n,-90),mceImageRotateRight:ht(t,n,90),mceImageFlipVertical:gt(t,n,"v"),mceImageFlipHorizontal:gt(t,n,"h"),mceEditImage:pt(t,n)},function(n,e){t.addCommand(e,n)})},wt=function(t,n,e){t.on("NodeChange",function(r){var o=e.get();o&&o.src!==r.element.src&&(lt(n),t.editorUpload.uploadImagesAuto(),e.set(null)),et(t,r.element).each(e.set)})},bt=function(t){var n=function(n){return function(){return t.execCommand(n)}};t.ui.registry.addButton("rotateleft",{tooltip:"Rotate counterclockwise",icon:"rotate-left",onAction:n("mceImageRotateLeft")}),t.ui.registry.addButton("rotateright",{tooltip:"Rotate clockwise",icon:"rotate-right",onAction:n("mceImageRotateRight")}),t.ui.registry.addButton("flipv",{tooltip:"Flip vertically",icon:"flip-vertically",onAction:n("mceImageFlipVertical")}),t.ui.registry.addButton("fliph",{tooltip:"Flip horizontally",icon:"flip-horizontally",onAction:n("mceImageFlipHorizontal")}),t.ui.registry.addButton("editimage",{tooltip:"Edit image",icon:"edit-image",onAction:n("mceEditImage"),onSetup:function(n){var e=function(){ot(t).each(function(e){var r=et(t,e.dom()).isNone();n.setDisabled(r)})};return t.on("NodeChange",e),function(){t.off("NodeChange",e)}}}),t.ui.registry.addButton("imageoptions",{tooltip:"Image options",icon:"image-options",onAction:n("mceImage")}),t.ui.registry.addContextMenu("imagetools",{update:function(e){return et(t,e).fold(function(){return[]},function(t){return[{text:"Edit image",icon:"edit-image",onAction:n("mceEditImage")}]})}})},It=function(t){t.ui.registry.addContextToolbar("imagetools",{items:F(t),predicate:function(n){return et(t,n).isSome()},position:"node",scope:"node"})};i.add("imagetools",function(t){var n=o(0),e=o(null);yt(t,n),bt(t),It(t),wt(t,n,e)})}(window);